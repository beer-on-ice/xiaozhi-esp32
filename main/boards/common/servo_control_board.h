#ifndef SERVO_CONTROL_BOARD_H
#define SERVO_CONTROL_BOARD_H

#include "protocol.h"
#include <cJSON.h>
#include <cstdint>
#include <freertos/FreeRTOS.h>
#include <freertos/task.h>
#include <mqtt.h>

// 指定 UART1 所使用引脚和波特率
#define UART1_TX_PIN 17
#define UART1_RX_PIN 18
#define UART1_BAUD_RATE 9600
#define BUF_SIZE 1024

// 日志服务器的 IP 和端口
#define ESP32C6_IP "192.168.0.100" // 替换为你的服务器IP
#define ESP32C6_PORT 8888          // 常用的syslog端口

#define MQTT_ADDRESS "58.211.186.6"
#define MQTT_PORT 1883
#define MQTT_CLIENT_ID "MDSDAI_No.Mars"
#define MQTT_USERNAME "xiaomai"
#define MQTT_PASSWORD "xiaomai@123"

#define MQTT_SUBSCRIBE_TOPIC "esp32c6/98:A3:16:8F:79:74/data/humanDetected"

class ServoControlBoard {
  public:
    static ServoControlBoard& GetInstance() {
        static ServoControlBoard instance;
        return instance;
    }

    bool instruction_mode_ = false;

    std::string mqtt_publish_topic_log_deviceState_ = "esp32s3/%s/log/deviceState";
    std::string mqtt_publish_topic_mcp_mobileChassis_ = "esp32s3/%s/mcp/mobileChassis";

    /*基础动作*/
    void init_header();
    TaskHandle_t faceAction_eyelid_handle_ = nullptr;
    TaskHandle_t faceAction_eyeball_handle_ = nullptr;
    TaskHandle_t faceAction_chin_handle_ = nullptr;

    /*自定义表情*/
    void neutral();
    void speaking_state();
    void sleepy();
    void stop_chin();

    void udp_send(const std::string& host, int port, const std::string& text); // 发送日志
    void init_esp_now();                                                       // 初始化ESP NOW

    void mqtt_publish(const std::string& text);

    void init_mqtt();

  private:
    ServoControlBoard(); // 私有构造函数
    // 删除拷贝构造和赋值操作符,确保单例性
    ServoControlBoard(const ServoControlBoard&) = delete;
    ServoControlBoard& operator=(const ServoControlBoard&) = delete;

    std::string mac_ = "98:A3:16:E4:18:78";

    std::unique_ptr<Udp> udp_instance_;
    std::unique_ptr<Mqtt> mqtt_instance_;

    void add_mcp_tools(); // 添加MCP工具

    void init_uart1(); // 初始化UART1

    void init_eyelid();  // 初始化眼皮
    void init_eyeball(); // 初始化眼球
    void init_chin();    // 初始化下巴

    /*--- 下巴 ---*/
    static constexpr uint8_t DM0_Speed_18_Position_70[10] = {0xff, 0x01, 0x00, 0x02, 0x00, 0xff, 0x02, 0x00, 0xfe, 0x04}; // 闭——限制 65
    static constexpr uint8_t DM0_Speed_18_Position_90[10] = {0xff, 0x01, 0x00, 0x02, 0x00, 0xff, 0x02, 0x00, 0xc7, 0x04}; // 初始 85
    static constexpr uint8_t DM0_Speed_18_Position_120[10] = {0xff, 0x01, 0x00, 0x02, 0x00, 0xff, 0x02, 0x00, 0xfe, 0x04}; //  停 70

    static constexpr uint8_t DM0_Speed_90_Position_75[10] = {0xff, 0x01, 0x00, 0x04, 0x00, 0xff, 0x02, 0x00, 0xfe, 0x04};
    static constexpr uint8_t DM0_Speed_90_Position_90[10] = {0xff, 0x01, 0x00, 0x04, 0x00, 0xff, 0x02, 0x00, 0x6d, 0x05}; // 说话——闭 80
    static constexpr uint8_t DM0_Speed_90_Position_95[10] = {0xff, 0x01, 0x00, 0x04, 0x00, 0xff, 0x02, 0x00, 0xa5, 0x05}; // 说话——开 85
    static constexpr uint8_t DM0_Speed_90_Position_100[10] = {0xff, 0x01, 0x00, 0x04, 0x00, 0xff, 0x02, 0x00, 0xdc, 0x05}; // 说话——开 90

    /*--- 右嘴角 ---*/
    static constexpr uint8_t DM1_Speed_90_Position_60[10] = {0xff, 0x01, 0x01, 0x0a, 0x00, 0xff, 0x02, 0x01, 0x42, 0x03}; // 上——限制
    static constexpr uint8_t DM1_Speed_18_Position_90[10] = {0xff, 0x01, 0x01, 0x02, 0x00, 0xff, 0x02, 0x01, 0x8f, 0x04}; // 初始
    static constexpr uint8_t DM1_Speed_90_Position_120[10] = {0xff, 0x01, 0x01, 0x0a, 0x00, 0xff, 0x02, 0x01, 0x76, 0x08}; // 下——限制
    static constexpr uint8_t DM1_Speed_18_Position_80[10] = {0xff, 0x01, 0x01, 0x02, 0x00, 0xff, 0x02, 0x01, 0xfe, 0x04}; // 待命状态

    /*--- 左嘴角 ---*/
    static constexpr uint8_t DM2_Speed_90_Position_120[10] = {0xff, 0x01, 0x02, 0x0a, 0x00, 0xff, 0x02, 0x02, 0x76, 0x08}; // 上——限制
    static constexpr uint8_t DM2_Speed_18_Position_90[10] = {0xff, 0x01, 0x02, 0x02, 0x00, 0xff, 0x02, 0x02, 0x8f, 0x04}; // 初始
    static constexpr uint8_t DM2_Speed_90_Position_60[10] = {0xff, 0x01, 0x02, 0x02, 0x00, 0xff, 0x02, 0x02, 0x8e, 0x04}; // 下——限制
    static constexpr uint8_t DM2_Speed_18_Position_100[10] = {0xff, 0x01, 0x02, 0x02, 0x00, 0xff, 0x02, 0x02, 0xba, 0x06}; // 待命状态
    static constexpr uint8_t DM2_Speed_90_Position_110[10] = {0xff, 0x01, 0x02, 0x02, 0x00, 0xff, 0x02, 0x02, 0x29, 0x07}; // 放电状态

    /*--- 眼睛 ---*/
    static constexpr uint8_t DM4_Speed_90_Position_70[10] = {0xff, 0x01, 0x04, 0x0a, 0x00, 0xff, 0x02, 0x04, 0x8f, 0x04}; // 左——限制
    static constexpr uint8_t DM4_Speed_90_Position_90[10] = {0xff, 0x01, 0x04, 0x0a, 0x00, 0xff, 0x02, 0x04, 0xdc, 0x05}; // 初始
    static constexpr uint8_t DM4_Speed_90_Position_110[10] = {0xff, 0x01, 0x04, 0x0a, 0x00, 0xff, 0x02, 0x04, 0x29, 0x07}; // 右——限制

    /*--- 右眼皮 ---*/
    static constexpr uint8_t DM5_Speed_90_Position_65[10] = {0xff, 0x01, 0x05, 0x0a, 0x00, 0xff, 0x02, 0x05, 0xc6, 0x04}; // 闭——限制
    static constexpr uint8_t DM5_Speed_90_Position_90[10] = {0xff, 0x01, 0x05, 0x0a, 0x00, 0xff, 0x02, 0x05, 0xdc, 0x05}; // 初始
    static constexpr uint8_t DM5_Speed_90_Position_115[10] = {0xff, 0x01, 0x05, 0x0a, 0x00, 0xff, 0x02, 0x05, 0xf1, 0x06}; // 开——限制

    /*--- 左眼皮 ---*/
    static constexpr uint8_t DM6_Speed_90_Position_115[10] = {0xff, 0x01, 0x06, 0x0a, 0x00, 0xff, 0x02, 0x06, 0xf1, 0x06}; // 闭——限制
    static constexpr uint8_t DM6_Speed_90_Position_90[10] = {0xff, 0x01, 0x06, 0x0a, 0x00, 0xff, 0x02, 0x06, 0xdc, 0x05}; // 初始
    static constexpr uint8_t DM6_Speed_90_Position_65[10] = {0xff, 0x01, 0x06, 0x0a, 0x00, 0xff, 0x02, 0x06, 0xc6, 0x04}; // 开——限制

    /*--- 脖子 ---*/
    static constexpr uint8_t DM12_Speed_18_Position_0[10] = {0xff, 0x01, 0x0c, 0x02, 0x00, 0xff, 0x02, 0x0c, 0x00, 0x00}; // 右——限制
    static constexpr uint8_t DM12_Speed_18_Position_90[10] = {0xff, 0x01, 0x0c, 0x02, 0x00, 0xff, 0x02, 0x0c, 0xdc, 0x05}; // 初始
    static constexpr uint8_t DM12_Speed_18_Position_180[10] = {0xff, 0x01, 0x0c, 0x02, 0x00, 0xff, 0x02, 0x0c, 0xc4, 0x09}; // 左——限制

    static constexpr uint8_t DM12_Speed_36_Position_60[10] = {0xff, 0x01, 0x0c, 0x04, 0x00, 0xff, 0x02, 0x0c, 0x8e, 0x04};  // 右转
    static constexpr uint8_t DM12_Speed_36_Position_120[10] = {0xff, 0x01, 0x0c, 0x04, 0x00, 0xff, 0x02, 0x0c, 0x29, 0x07}; // 左转

    /*--- 动作组 ---*/
    unsigned char DM_Action0[5] = {0xff, 0x09, 0x00, 0x00, 0x00};
    unsigned char DM_Action1[5] = {0xff, 0x09, 0x00, 0x01, 0x00};
    unsigned char DM_Action2[5] = {0xff, 0x09, 0x00, 0x02, 0x00};
    unsigned char DM_Action3[5] = {0xff, 0x09, 0x00, 0x03, 0x00};
    unsigned char DM_Action4[5] = {0xff, 0x09, 0x00, 0x04, 0x00};
    unsigned char DM_Action5[5] = {0xff, 0x09, 0x00, 0x05, 0x00};
    unsigned char DM_Action6[5] = {0xff, 0x09, 0x00, 0x06, 0x00};
    unsigned char DM_Action7[5] = {0xff, 0x09, 0x00, 0x07, 0x00};
    unsigned char DM_Action8[5] = {0xff, 0x09, 0x00, 0x08, 0x00};
    unsigned char DM_Action9[5] = {0xff, 0x09, 0x00, 0x09, 0x00};
    unsigned char DM_Action10[5] = {0xff, 0x09, 0x00, 0x0a, 0x00};
    unsigned char DM_Action11[5] = {0xff, 0x09, 0x00, 0x0b, 0x00};
    unsigned char DM_Action12[5] = {0xff, 0x09, 0x00, 0x0c, 0x00};
    unsigned char DM_Action13[5] = {0xff, 0x09, 0x00, 0x0d, 0x00};
    unsigned char DM_Action14[5] = {0xff, 0x09, 0x00, 0x0e, 0x00};
    unsigned char DM_Action15[5] = {0xff, 0x09, 0x00, 0x0f, 0x00};

    unsigned char DM_STOP[5] = {0xff, 0x0b, 0x00, 0x01, 0x00};  // 停止
    unsigned char DM_RENEW[5] = {0xff, 0x0b, 0x00, 0x00, 0x00}; // 恢复
};
inline ServoControlBoard& scb = ServoControlBoard::GetInstance();
#endif